name: Laravel El-admin Test

on:
  push:
    branches: ["1.0.1", "2.0.0"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - php: '8.0'
            laravel: '9.*'
            branch: '1.0.1'
            test-dir: 'laravel-tests/el-admin'
          - php: '8.1'
            laravel: '10.*'
            branch: '1.0.1'
            test-dir: 'laravel-tests/el-admin'
          - php: '8.2'
            laravel: '11.*'  # 可能需要根据实际情况调整
            branch: '2.0.0'
            test-dir: 'laravel-tests/el-admin'
          - php: '8.2'
            laravel: '12.*'  # 可能需要根据实际情况调整
            branch: '2.0.0'
            test-dir: 'laravel-tests/el-admin'
    name: Laravel ${{ matrix.laravel }} (PHP ${{ matrix.php }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: opcache

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: 5.7
          mysql root password: 123456
          mysql database: laravel
          mysql user: root
          mysql password: 124567

      - name: Update Composer
        run: composer self-update --2

      - name: Install Dependencies
        run: |
          composer create-project --prefer-dist laravel/laravel laravel-tests ${{ matrix.laravel }}
          cd laravel-tests && composer install

      - name: Setup Environment
        run: |
          sudo apt-get install -y xvfb
          sh ./tests/bin/install.sh
          sh ./tests/bin/start.sh

      - name: Run Tests
        run: cd ./${{ matrix.test-dir }} && ./vendor/bin/phpunit tests/
